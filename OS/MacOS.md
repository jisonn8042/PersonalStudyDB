# 初めてのmacOS

## 目次

Ⅰ. macOSについて

AppleがDarwinを基盤としてMac専用運営体制を開発しました。

DarwinのカーネルはXNUになっています。

XNUはMachとBSDを基盤として構成されている【ハイブリッドカーネル】です。

Mach（マイクロカーネル）-カーネルの一番低い基盤を担当
"カーネルは必須的な機能のみ行うこと"をベースで作られました。
プロセス・スレッドスケジューリング（CPU管理）
メモリ管理（仮想メモリ）
IPC(プロセス間通信)

BSD（モノリシックネル）-カーネルにUNIXサービス提供
ファイルシステム（APFS、HFS+）
ネットワーク（TCP/IP）
POSIX API（UNIX標準インタフェース提供）
プロセスモデル（PID、権限等UNIXスタイルのプロセス管理）

<img alt="XNUKernel-Architecture-img" src="/OS/images/XNUKernelArchitecture.webp" width="500" height="305">

1．XNUKernelイメージ

Ⅱ. プロセス管理

コード実行の全般的な流れ（TOP-DOWN）
ケース1
ユーザが.appをダブルクリックした時

1.アプリを実行しろ -ユーザが実行対象をダブルクリック（GUIレベル）
2.FinderがLaunch Services（実行サービス）にアプリ実行を要請する（GUIShellレベル）
    2-1. Finder（GUIShell）がクリックイベントを受ける
    2-2. FinderがInfo.plistのファイルを読んで実際実行ファイルやそのために必要な権限を確認する
    2-3. FinderがLaunch Services（実行サービス）にアプリ実行を要請する
    2-4. Launch Services（実行サービス）が'アプリが既に実行中なのか'、'実現権限があるのか'をチェックする
3. Launch Services（実行サービス）がlauchd(PID 1)プロセスに実行を任せる。（サービス管理レベル）
4. 新しいプロセスを作るシステムコールを呼び出しプロセスを作り、アプリのコードをメモリに上書きする（システムコールレベル）
    4-1. lauchd及び関連システムライブラリがカーネルにシステムコールを呼び出し現在のプロセスを複製した子供プロセスを作る（posix_spawn()やfork()を活用）
    4-2. execve()を活用し、子供プロセスのメモリにアプリのコードを上書きする
5. XNUカーネルのBSD階層が子供プロセスにPIDやファイル権限等を付けてプロセス管理し始める（カーネルレベル1）
    5-1. BSD階層が子供プロセスにPID、ファイル権限等を付けてプロセス管理し始める
    5-2. BSDがディスクでアプリの実行ファイルを読む準備をする。
6. XNUカーネルのMachがCPU上で実行できるよう準備する -実行もための資源を割り当てる（カーネルレベル2）
    6-1. Machがこのプロセスのためのテスクを生成する
    6-2. このテスクにVirtualMemory（仮想メモリ）スペースを割り当てる
    6-3. スレッドを生成しCPUで実行できるよう準備する
7. dyld(DynamicLinker)がアプリの実行のために必要なものを準備し、アプリの実行最初の関数を呼び出す（プロセス初期化レベル）
    7-1. カーネルはアプリの実行ファイルとdyld（DynamicLinker）をプロセスメモリにロードしプログラムの制御兼をdyldに渡す
    7-2. dyldはアプリが実行するために必要な共有ライブラリやフレームワークを探してメモリにロードし連結する。
    7-3. 準備が終わったらアプリを実行できるトリガー関数を実行する
8. プログラム実行、管理（Application&OSレベル）
    8-1. 実行
        - トリガー関数が呼び出されアプリのコードが実行される
        - アプロはWindowServerに接続しウィンドウが出てDockにアイコンが現れる
    8-2. 管理
        - スケジューリング（Mach）
        - メモリ管理（Mach）
        - イベント処理（BSD/Mach）
        - 終了
        - モニタリング

Ⅲ. プロセス同期化

. メモリ管理

容量管理

ファイルシステム

保安

仮想マシン

ネットワーク

通信の全般的な流れ（TOP-DOWN, BOTTOM-UP）

分散システム




プログラム実行

親のプロセスを複製し、子供プロセスを生成
複製された子供プロセスが自分のメモリに実行するプログラムのコードを上書きして実行

posix_spawn()やfolk() + execve()を使用

folk()
親のプロセスを複製し、子供プロセスを生成

execve()
複製された子供プロセスが自分のメモリに実行するプログラムのコードを上書きして実行

XNUカーネルはプロセスを
［BSDプロセス］（PID、権限管理）+［Machテスク］（メモリ、スレッド）のハイブリッド管理する。

Windowsの場合CreateProcessというAPI関数を使用し、親プロセスがカーネルに完全に新しいプロセスを作らせてもらう（forkみたいに複製する方式とは違う）

通信


保安



Ⅱ. macOS構造

</br>
</br>

## Ⅰ. macOSについて

